<!DOCTYPE html>
<html>

<head>
  <title>Проект "Комменты"</title>
  <meta charset="utf-8" />
  <link rel="stylesheet" href="styles.css" />
</head>

<body>
  <div class="container">
    <div class="loading" id="loading">Комментарии загружаются...</div>
    <ul class="comments" id="comments">
      <!-- Рендерится из JS   -->
    </ul>
    <div class="add-form">
      <input type="text" class="add-form-name" placeholder="Введите ваше имя" id="input-name" value="" />
      <textarea type="textarea" class="add-form-text" id="add-form-text" placeholder="Введите ваш коментарий" rows="4"
        value=""></textarea>
      <div class="add-form-row">
        <button class="add-form-button" id="add-form-button">Написать</button>
      </div>
    </div>
  </div>
</body>

<script>
  // "use strict";
  const buttonElement = document.getElementById("add-form-button");
  const ListElement = document.getElementById("comments")
  const inputNameElement = document.getElementById("input-name")
  const inputTextElement = document.getElementById("add-form-text")
  const TimeElement = document.getElementById("Time")
  const LikeButtons = document.querySelectorAll("like-button")
  const LikesCounter = document.getElementById("likes-counter")
  const loading = document.getElementById('loading')

  function fetchGet() {
    fetch('https://wedev-api.sky.pro/api/v1/ekaterina-zalygina/comments', {
      method: "GET",
    }).then((response) => {

      if (response.status === 500) {
        throw new Error("Сервер поломался")
      }

      return response.json();


    }).then((responseData) => {
      const appComments = responseData.comments.map((comment) => {

        let myDate = new Date();
        let fullDate = myDate.toLocaleDateString() + ' ' + myDate.toLocaleTimeString()
        myDate.toLocaleDateString();
        myDate.toLocaleTimeString();

        return {
          name: comment.author.name,
          date: fullDate,
          text: comment.text,
          likes: comment.likes,
          isLiked: false
        }
      })
      Comments = appComments
      renderCommentsSample()
      loading.style.display = "none"
      inputTextElement.value = ""
      inputNameElement.value = ""
    }).catch((error) => {
      if (error.message === "Failed to fetch") {
        alert("Сервер поломался, попробуйте позже")
        loading.textContent = "Комментарии не загрузились";
        return
      }
      alert(error.message)
    })
  }

  let Comments = []

  fetchGet()

  const jsonComments = JSON.stringify(Comments);
  console.log(jsonComments)

  // const CommentsNew = JSON.parse(jsonComments);
  // console.log(CommentsNew)

  const LikesUser = () => {
    const LikeButtons = document.querySelectorAll(".like-button")
    for (const LikeButton of LikeButtons)
      LikeButton.addEventListener("click", (event) => {
        event.stopPropagation()
        const index = LikeButton.dataset.index;

        if (Comments[index].isLiked === false) {
          Comments[index].isLiked = true;
          Comments[index].likes++;
        }
        else {
          Comments[index].isLiked = false;
          Comments[index].likes--;
        }
        renderCommentsSample()
      })
  }

  const ReplyToСomment = () => {
    const CommUser = document.querySelectorAll(".comment-text")
    for (const CommUsers of CommUser)
      CommUsers.addEventListener("click", () => {
        const index = CommUsers.dataset.index;
        const inputTextElement = document.getElementById("add-form-text");
        const CaseTextComment = document.querySelectorAll(".comment-body");
        inputTextElement.value = `${Comments[index].name}:\n${Comments[index].text}`;
        renderCommentsSample();
      })
  }

  let renderCommentsSample = () => {
    const CommentsHTML = Comments.map((comment, index) => {
      return `<li class="comment" id="comment">
    <div class="comment-header">
    <div>${comment.name}</div>
    <div>${comment.date}</div>
    </div>
    <div class="comment-body">
    <div class="comment-text" data-index="${index}">
    ${comment.text}
    </div>
    </div>
    <div class="comment-footer">
    <div class="likes">
    <span class="likes-counter" id="LikesCounter">${comment.likes}</span>
    <button class="like-button ${comment.isLiked ? '-active-like' : ""}" id="LikeButton" data-index="${index}"></button>
    </div>
    </div>
    </li>`
    }).join('');

    ListElement.innerHTML = CommentsHTML

    LikesUser();
    ReplyToСomment();
  }

  renderCommentsSample();

  const initEventListeners = () => {
    const LikesElements = document.querySelectorAll('.like-button')
    console.log(LikesElements)

    for (const LikesElement of LikesElements) {
      LikesElement.addEventListener('click', () => {
        console.log(LikesElement.dataset.likes)
      })
    }
  }

  // Удаление комментария 
  // в  const renderCommentsSample в случае чего вставить строчку <button class="delete-button" data-index="index">Удалить</button> , т.к в функции она почему-то не комметировалась, чтобы не потерять, написала сюда как заметку 

  // const initDeleteButtonsListeners  = () => {
  //   const DeleteButtonElements = document.querySelectorAll('.delete-button')

  //   for(const DeleteButtonsElements of DeleteButtonElements) {
  //     DeleteButtonsElements.addEventListener('click', () => {
  //       const index = DeleteButtonsElements.dataset.index
  //       Comments.splice(index, 1)
  //       renderCommentsSample();
  //     })
  //   }
  // }

  initEventListeners();
  // initDeleteButtonsListeners();

  buttonElement.addEventListener("click", () => {
    inputNameElement.style.backgroundColor = "";
    inputTextElement.style.backgroundColor = "";

    if (inputNameElement.value.trim() === "") {
      inputNameElement.style.backgroundColor = "red";
      return;
    };

    if (inputTextElement.value.trim() === "") {
      inputTextElement.style.backgroundColor = "red";
      return;
    };


    const day = ['Воскресенье', 'Понедельник', 'Вторник', 'Среда', 'Четверг', 'Пятница', 'Суббота']
    const month = ['Январь', 'Февраль', 'Март', 'Апрель', 'Май', 'Июнь', 'Июль', 'Август', 'Сентябрь', 'Октябрь', 'Ноябрь', 'Декабрь']

    let myDate = new Date();
    let Mymonth = myDate.getMonth() + 1
    let fullDate = myDate.getDate() + '.' + Mymonth + '.' + myDate.getFullYear() + ' ' + myDate.getHours() + ':' + myDate.getMinutes()

    // Comments.push({
    //   name: inputNameElement.value.replaceAll('<', '&lt;').replaceAll('>', '&gt;'),
    //   date: fullDate,
    //   text: inputTextElement.value.replaceAll('<', '&lt;').replaceAll('>', '&gt;'),
    //   like: 0,
    //   isLiked: false
    // });

    buttonElement.disabled = true;
    buttonElement.textContent = "Комментарий добавляется...";
    fetchPost();

    function fetchPost() {

      fetch('https://wedev-api.sky.pro/api/v1/ekaterina-zalygina/comments', {
        method: "POST",
        body: JSON.stringify({
          name: inputNameElement.value.replaceAll('<', '&lt;').replaceAll('>', '&gt;'),
          text: inputTextElement.value.replaceAll('<', '&lt;').replaceAll('>', '&gt;'),
          forceError: true
        })
      })
        .then((response) => {

          if (response.status === 400) {
            buttonElement.textContent = ""
            throw new Error("Вы ввели имя короче 3-х символов");
          }
          if (response.status === 500) {
            buttonElement.textContent = ""
            throw new Error("Ошибка сервера");
          }

          if (response.status === 201) {
            return response.json()
          }

        })
        .then((responseData) => {
          return fetchGet();
        })
        .then(() => {
          buttonElement.disabled = false;
          buttonElement.textContent = "Написать";
          inputTextElement.value = " "
          inputNameElement.value = " "
        })
        .catch((error) => {
          buttonElement.disabled = false;
          buttonElement.textContent = "Написать";
          // alert("Упс, что-то пошло не так")
          loading.style.display = "none";

          if (error.message === "Вы ввели имя короче 3-х символов") {
            alert("Вы ввели имя и комментарий короче 3-х символов")
          }

          if (error.message === "Ошибка сервера") {
            alert("Сервер сломался, попробуйте позже")
          }

          if (error.message === "Failed to fetch") {
            buttonElement.textContent = "Написать"
            alert("Отсутствует подключение к интернету, попробуйте позже")
          }
          console.warn(error)
        })
      buttonElement.disabled = false;
      // console.warm(error)
    }
    // fetchPost();
    // fetchGet();
    // renderCommentsSample
    // initEventListeners();
    // initDeleteButtonsListeners();

    // })
    // console.log("It works!");
  })
</script>

</html>